---
# Kanata role tasks
# Only runs on MacBook Pro (is_macbook_pro == true)

- name: Skip kanata role if not MacBook Pro
  ansible.builtin.debug:
    msg: "Skipping kanata role - not a MacBook Pro"
  when: not is_macbook_pro | default(false)

- name: Run kanata setup tasks
  when: is_macbook_pro | default(false)
  block:
    # 1. Install kanata via Homebrew
    - name: Install kanata
      community.general.homebrew:
        name: "{{ kanata_package }}"
        state: present

    # 2. Stop kanata if running (before fixing directory permissions)
    - name: Stop kanata process
      ansible.builtin.shell: "sudo pkill -f kanata || true"
      changed_when: false

    # 3. Remove root-owned config directory if it exists
    - name: Check if kanata config directory exists with wrong permissions
      ansible.builtin.stat:
        path: "{{ kanata_config_dir }}"
      register: kanata_dir_stat

    - name: Remove root-owned kanata config directory
      ansible.builtin.shell: "sudo rm -rf {{ kanata_config_dir }}"
      when: kanata_dir_stat.stat.exists and kanata_dir_stat.stat.uid == 0
      changed_when: true

    # 4. Create config directory with correct permissions
    - name: Create kanata config directory
      ansible.builtin.file:
        path: "{{ kanata_config_dir }}"
        state: directory
        mode: "0755"

    # 5. Deploy configuration file
    - name: Copy kanata configuration file
      ansible.builtin.copy:
        src: kanata/kanata.kbd
        dest: "{{ kanata_config_file }}"
        mode: "0644"

    # 6. Get kanata binary path
    - name: Get kanata binary path
      ansible.builtin.command: which kanata
      register: kanata_bin_path
      changed_when: false

    # 7. Display manual LaunchDaemon setup instructions
    - name: Display LaunchDaemon setup instructions
      ansible.builtin.debug:
        msg: |
          Kanata configuration is ready!
          
          To set up auto-start (requires sudo):
          1. Run: cd {{ ansible_facts['user_dir'] }}/Workspace/settings/macos-settings
          2. Run: make setup-kanata-daemon
          
          Or manually run:
          sudo tee {{ kanata_launchd_plist }} <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>Label</key>
              <string>{{ kanata_launchd_label }}</string>
              <key>ProgramArguments</key>
              <array>
                  <string>{{ kanata_bin_path.stdout }}</string>
                  <string>--cfg</string>
                  <string>{{ kanata_config_file }}</string>
              </array>
              <key>RunAtLoad</key>
              <true/>
              <key>KeepAlive</key>
              <true/>
              <key>StandardOutPath</key>
              <string>/tmp/kanata.out.log</string>
              <key>StandardErrorPath</key>
              <string>/tmp/kanata.err.log</string>
          </dict>
          </plist>
          EOF
          
          sudo launchctl load -w {{ kanata_launchd_plist }}
